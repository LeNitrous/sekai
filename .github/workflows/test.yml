name: Test
on: push

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Install .NET
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: "7.0.x"

      - name: Install Optional Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-dev \
            libsdl2-dev \
            llvm-dev \
            xvfb \
            xauth

      - name: Test
        run: |
          wget -O xvfb-run.sh https://github.com/revnode/xvfb-run/raw/master/xvfb-run
          bash ./xvfb-run.sh -n 1 dotnet test Sekai.sln --logger "trx;LogFileName=${{ github.workspace }}/results.trx"
        env:
          # Tell SDL to use dummy drivers so we can run tests on CI
          # https://wiki.libsdl.org/FAQUsingSDL
          SDL_VIDEODRIVER: x11
          SDL_AUDIODRIVER: dummy

      - name: Upload Results
        uses: actions/upload-artifact@v2
        if: ${{ always() }}
        with:
          name: results
          path: ${{ github.workspace }}/results.trx
