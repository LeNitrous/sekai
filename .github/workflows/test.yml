name: Test
on: push

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Install .NET
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: "7.0.x"

      - name: Install Optional Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-dev \
            libsdl2-dev \
            llvm-dev \
            xvfb \
            xauth

      - name: Setup Xvfb
        run: |
          mkdir .staging
          wget -O Xvfb.service https://gist.githubusercontent.com/ypandit/f4fe751bcbf3ee6a32ca/raw/f2f3a955e430e1f574c985cec0947d55496066d3/Xvfb.service
          sudo mv Xvfb.service /etc/systemd/system/Xvfb.service
          sudo systemctl daemon-reload
          sudo systemctl start Xvfb
          sudo systemctl status Xvfb

      - name: Restore
        run: dotnet restore -v n Sekai.Universal.slnf /property:TargetFramework=net7.0

      - name: Build
        run: dotnet build -f net7.0 --no-restore -v n -c Debug Sekai.Universal.slnf

# TODO: We disabled tests since we haven't migrated them all to XUnit. This should be done soon.
#      - name: Test
#        run: dotnet test Sekai.sln --logger "trx;LogFileName=${{ github.workspace }}/results.trx"
#        env:
#          # Tell SDL to use dummy drivers so we can run tests on CI
#          # https://wiki.libsdl.org/FAQUsingSDL
#          SDL_VIDEODRIVER: x11
#          SDL_AUDIODRIVER: dummy
#          # Use Xvfb display
#          DISPLAY: :99

      - name: Upload Results
        uses: actions/upload-artifact@v2
        if: ${{ always() }}
        with:
          name: results
          path: ${{ github.workspace }}/results.trx
